# Руководство: Получение правильного пути к папке с буквой диска

## Проблема

Современные браузеры (Chrome, Edge, Firefox) не предоставляют прямой доступ к полным путям файлов и папок по соображениям безопасности. Это затрудняет получение правильного пути с буквой диска (например, `D:\folder`) при выборе папки через диалог браузера.

## Решение

В DocuSync реализован комплексный подход для получения правильного пути к папке:

### 1. Backend Endpoint для валидации и нормализации путей

**Эндпоинт:** `POST /api/sync/validate-path`

**Функция:** Валидирует и нормализует путь к папке, возвращая правильный путь с заглавной буквой диска.

**Пример запроса:**
```json
{
  "path": "d:\\my folder"
}
```

**Пример ответа:**
```json
{
  "success": true,
  "normalized_path": "D:\\my folder",
  "drive": "D",
  "exists": true,
  "is_directory": true
}
```

**Что делает эндпоинт:**
- Проверяет существование пути
- Проверяет, что путь является директорией
- Нормализует букву диска в верхний регистр (d: → D:)
- Удаляет лишние слеши в конце (кроме корня диска)
- Преобразует относительные пути в абсолютные
- Обрабатывает одиночные буквы дисков (D → D:\)

### 2. Frontend: Многоуровневый подход

#### Уровень 1: File System Access API (современные браузеры)

Используется `window.showDirectoryPicker()` для выбора папки:

```javascript
const dirHandle = await window.showDirectoryPicker({ mode: 'read' });
```

**Проблема:** API не предоставляет прямой доступ к пути.

**Решение:**
1. Читаем файлы из выбранной директории
2. Извлекаем пути из свойств `file.path` (если доступны)
3. Находим общий префикс всех путей (это и есть выбранная папка)
4. Если путь не удалось определить, показываем диалог для ввода пути

#### Уровень 2: Fallback - File Input с webkitdirectory

Для браузеров, не поддерживающих File System Access API:

```javascript
const folderPicker = document.createElement('input');
folderPicker.type = 'file';
folderPicker.setAttribute('webkitdirectory', '');
```

**Проблема:** `webkitRelativePath` дает только относительный путь.

**Решение:**
1. Проверяем свойство `file.path` у выбранных файлов
2. Извлекаем букву диска из путей файлов
3. Строим полный путь: `drive + \ + webkitRelativePath`
4. Если `file.path` недоступен, показываем диалог для ввода пути

#### Уровень 3: Backend Validation

После получения любого пути (даже частичного) вызывается backend для валидации:

```javascript
async function validateAndSetPath(path, input, inputId) {
    const response = await fetch('/api/sync/validate-path', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + currentToken
        },
        body: JSON.stringify({ path: path.trim() })
    });
    
    const result = await response.json();
    if (result.success && result.normalized_path) {
        input.value = result.normalized_path;
    }
}
```

**Преимущества:**
- Гарантирует правильный формат пути
- Проверяет существование папки
- Нормализует букву диска
- Обрабатывает различные форматы ввода (D, D:, D:\, D:\folder)

## Алгоритм работы

```
1. Пользователь нажимает "Browse"
   ↓
2. Пытаемся использовать File System Access API
   ↓
3. Если доступен:
   - Показываем диалог выбора папки
   - Читаем файлы из папки
   - Извлекаем пути из file.path
   - Находим общий префикс
   ↓
4. Если API недоступен:
   - Используем <input type="file" webkitdirectory>
   - Извлекаем пути из file.path
   - Строим путь из drive + webkitRelativePath
   ↓
5. Если путь не удалось определить:
   - Показываем диалог для ввода пути
   ↓
6. Валидируем путь через backend
   - POST /api/sync/validate-path
   - Получаем нормализованный путь
   - Устанавливаем в поле ввода
```

## Примеры обработки различных форматов

| Ввод пользователя | Нормализованный путь |
|-------------------|---------------------|
| `D` | `D:\` |
| `D:` | `D:\` |
| `D:\` | `D:\` |
| `d:\folder` | `D:\folder` |
| `D:/folder` | `D:\folder` |
| `folder` | Показывается диалог для ввода полного пути |

## Обработка ошибок

1. **Путь не существует:**
   - Backend возвращает 404
   - Показывается сообщение об ошибке
   - Пользователь может ввести путь вручную

2. **Путь не является директорией:**
   - Backend возвращает 400
   - Показывается сообщение об ошибке

3. **Путь не содержит букву диска:**
   - Показывается предупреждение
   - Пользователь может ввести полный путь вручную

4. **Backend недоступен:**
   - Используется путь, введенный пользователем
   - Показывается предупреждение

## Рекомендации для пользователей

1. **Если путь не определяется автоматически:**
   - Введите полный путь вручную в формате `D:\folder\subfolder`
   - Используйте обратные слеши (`\`) для Windows
   - Буква диска будет автоматически преобразована в верхний регистр

2. **Для быстрого ввода:**
   - Можно ввести только букву диска (например, `D`)
   - Система автоматически преобразует в `D:\`

3. **Проверка пути:**
   - После ввода пути система автоматически проверяет его существование
   - Если путь неверен, будет показано сообщение об ошибке

## Технические детали

### Backend (Python)

```python
@app.post("/api/sync/validate-path")
async def validate_path(request: PathValidationRequest):
    # 1. Проверка на пустой путь
    # 2. Обработка одиночной буквы диска
    # 3. Получение абсолютного пути
    # 4. Проверка существования
    # 5. Проверка, что это директория
    # 6. Нормализация буквы диска
    # 7. Удаление лишних слешей
    # 8. Возврат нормализованного пути
```

### Frontend (JavaScript)

```javascript
// Основная функция выбора папки
async function browseFolder(inputId) {
    // 1. Пробуем File System Access API
    // 2. Fallback на webkitdirectory
    // 3. Извлечение пути из file.path
    // 4. Валидация через backend
    // 5. Установка нормализованного пути
}
```

## Заключение

Комбинация frontend-извлечения пути и backend-валидации обеспечивает надежное получение правильного пути к папке с буквой диска, даже когда браузер не предоставляет прямой доступ к путям файловой системы.

