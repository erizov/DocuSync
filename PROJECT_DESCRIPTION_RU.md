# DocuSync - Описание проекта и экраны функциональности

## 1. Описание проекта

### 1.1 Общая информация

**DocuSync** — это мощная система управления документами, разработанная на базе FastAPI. Система предназначена для организации, синхронизации и поиска документов в коллекциях, распределенных по нескольким дискам или папкам.

### 1.2 Основные возможности

#### 1.2.1 Сканирование и индексация документов
- Автоматическое сканирование всех дисков или выбранных дисков
- Поддержка множества форматов: PDF, DOCX, TXT, EPUB, DJVU, ZIP, DOC, RAR, FB2, HTML, RTF, GIF, PPT, MP3
- Извлечение метаданных: имя документа, путь, автор, размер, дата создания
- Расчет MD5-хеша для идентификации дубликатов
- Извлечение текстового содержимого для полнотекстового поиска

#### 1.2.2 Мощный поиск
- Полнотекстовый поиск внутри содержимого документов (PDF, DOCX, TXT, EPUB)
- Поиск по метаданным: имя, автор, путь к файлу
- Фильтрация по дискам
- Быстрые запросы к оптимизированной базе данных SQLite
- Поддержка FTS5 для ускоренного поиска (в 10-50 раз быстрее)
- Поддержка булевых операторов (AND, OR, NOT) и поиска фраз

#### 1.2.3 Обнаружение и управление дубликатами
- Два типа обнаружения дубликатов:
  1. **Одинаковое содержимое, разные имена**: Файлы с идентичным содержимым (одинаковый MD5-хеш), но разными именами
  2. **Одинаковое имя, разное содержимое**: Файлы с одинаковым именем, но разным содержимым (разный MD5-хеш)
- Интерактивный выбор: для каждой группы дубликатов можно выбрать, какой файл оставить
- Анализ экономии места: просмотр объема, который будет освобожден перед удалением
- Безопасная операция: предварительный просмотр перед удалением с подтверждением

#### 1.2.4 Синхронизация дисков и папок
- Двунаправленная синхронизация между любыми двумя дисками или папками
- Веб-интерфейс синхронизации: визуальный двухпанельный интерфейс для сравнения и синхронизации
- Умные стратегии синхронизации:
  - **Сохранить оба**: Сохранить обе версии с суффиксами
  - **Сохранить новейший**: Автоматически сохранить самый недавно измененный файл
  - **Сохранить больший**: Сохранить файл с большим размером
- Анализ места: точная информация о необходимом объеме на каждом диске/папке
- Сохранение структуры дерева: поддержка иерархии подпапок при синхронизации
- Режим предварительного просмотра: просмотр операций синхронизации перед выполнением

#### 1.2.5 Управление пользователями и безопасность
- Контроль доступа на основе ролей: три роли пользователей (readonly, full, admin)
- Интерфейс управления пользователями: администратор может создавать, редактировать и удалять пользователей
- Управление паролями: изменение паролей пользователей и управление учетными записями
- Управление сессиями:
  - Автоматический выход после 1 часа бездействия
  - Кнопка выхода в заголовке
  - Безопасная аутентификация на основе токенов JWT
- Отслеживание активности: мониторинг активности пользователя для принудительного таймаута

#### 1.2.6 Многоязычная поддержка
- Поддержка 6 языков: английский, немецкий, французский, испанский, итальянский, русский
- Динамическое переключение языка без перезагрузки страницы
- Полностью переведенный интерфейс: все элементы UI, кнопки, сообщения и формы на всех страницах
- Сохранение языка: выбранный язык сохраняется в хранилище браузера и используется на всех страницах
- Автоопределение: автоматическое определение языка браузера при первом посещении
- Централизованное управление языком: селектор языка доступен только на главной странице синхронизации; все остальные страницы используют выбранный язык автоматически

#### 1.2.7 Отчеты и аналитика
- Отчет по активности: просмотр всех операций с документами
- Отчет по сэкономленному месту: статистика освобожденного дискового пространства
- Отчет по операциям: статистика по типам операций
- Отчет по поврежденным PDF: обнаружение PDF-файлов, которые не существуют на диске или имеют размер 0

### 1.3 Технологический стек

- **Framework**: FastAPI 0.104.1
- **База данных**: SQLite с SQLAlchemy 2.0.23
- **Аутентификация**: JWT (python-jose) с bcrypt
- **Валидация**: Pydantic 2.5.0
- **CLI**: Typer 0.9.0 с Rich
- **Тестирование**: pytest 7.4.3
- **Python**: >= 3.9

### 1.4 Роли пользователей

- **readonly**: Может просматривать и искать документы, но не может изменять или синхронизировать
- **full**: Может просматривать, искать и выполнять операции синхронизации
- **admin**: Полный доступ, включая управление пользователями и просмотр отчетов

---

## 2. Экраны функциональности

### 2.1 Экран входа (Login Page)

**URL:** `/login`

#### Описание
Экран входа в систему. Пользователь вводит имя пользователя и пароль для получения доступа к системе.

#### Элементы интерфейса:
- **Заголовок**: "DocuSync" или "Вход в систему"
- **Поле ввода имени пользователя**: Текстовое поле с меткой "Имя пользователя"
- **Поле ввода пароля**: Поле ввода пароля с меткой "Пароль"
- **Кнопка "Войти"**: Кнопка для отправки формы входа
- **Сообщения об ошибках**: Отображение ошибок аутентификации (если есть)

#### Визуальное представление:
```
┌─────────────────────────────────────┐
│         DocuSync                    │
│                                     │
│    ┌───────────────────────────┐   │
│    │ Имя пользователя          │   │
│    │ [________________]         │   │
│    └───────────────────────────┘   │
│                                     │
│    ┌───────────────────────────┐   │
│    │ Пароль                     │   │
│    │ [________________]         │   │
│    └───────────────────────────┘   │
│                                     │
│         [  Войти  ]                 │
│                                     │
└─────────────────────────────────────┘
```

#### Функциональность:
- Валидация полей ввода
- Отправка данных на сервер для аутентификации
- Сохранение JWT токена в localStorage браузера
- Перенаправление на страницу синхронизации после успешного входа
- Отображение сообщений об ошибках при неудачной аутентификации

#### Учетные данные по умолчанию:
- Имя пользователя: `admin`
- Пароль: `admin`

---

### 2.2 Экран синхронизации (Sync Interface)

**URL:** `/sync`

#### Описание
Главный экран приложения. Предоставляет интерфейс для синхронизации папок и дисков, управления пользователями и доступа к отчетам.

#### Элементы интерфейса:

##### Заголовок (Header):
- **Логотип/Название**: "DocuSync"
- **Селектор языка**: Выпадающий список с 6 языками (en, de, fr, es, it, ru)
- **Информация о пользователе**: "Вошли как: [имя пользователя] ([роль])"
- **Кнопка "Управление пользователями"**: Видна только для администраторов
- **Кнопка "Отчеты"**: Видна только для администраторов
- **Кнопка "Выйти"**: Выход из системы

##### Основная область:

**1. Параметры синхронизации:**
- **Поле "Папка 1"**: Текстовое поле с кнопкой "Обзор" для выбора первой папки/диска
- **Поле "Папка 2"**: Текстовое поле с кнопкой "Обзор" для выбора второй папки/диска
- **Селектор стратегии синхронизации**: Выпадающий список с опциями:
  - Сохранить оба
  - Сохранить новейший
  - Сохранить больший
- **Кнопка "Анализировать"**: Запуск анализа различий между папками
- **Кнопка "Выполнить синхронизацию"**: Видна только для ролей full и admin

**2. Результаты анализа (двухпанельный вид):**
- **Левая панель (Папка 1)**:
  - Список файлов, которые нужно скопировать в папку 2
  - Список дубликатов (файлы с одинаковым путем, но разным содержимым)
  - Список подозрительных дубликатов (файлы с одинаковым содержимым, но разными путями)
- **Правая панель (Папка 2)**:
  - Список файлов, которые нужно скопировать в папку 1
  - Список дубликатов
  - Список подозрительных дубликатов

**3. Панель статуса:**
- Индикатор прогресса синхронизации
- Текущий обрабатываемый файл
- Статистика: количество обработанных файлов, общий размер
- Сообщения об ошибках (если есть)

#### Визуальное представление:
```
┌─────────────────────────────────────────────────────────────────┐
│ DocuSync  [Язык: RU ▼]  Вошли как: admin (admin)  [Пользователи] [Отчеты] [Выйти] │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ Папка 1: [C:\folder1                    ] [Обзор]             │
│ Папка 2: [D:\folder2                    ] [Обзор]               │
│ Стратегия: [Сохранить новейший ▼]                             │
│                                                                 │
│ [Анализировать]  [Выполнить синхронизацию]                     │
│                                                                 │
├──────────────────────────┬──────────────────────────────────────┤
│   Папка 1               │   Папка 2                            │
├──────────────────────────┼──────────────────────────────────────┤
│ Файлы для копирования:  │ Файлы для копирования:               │
│ • file1.pdf             │ • file3.pdf                          │
│ • file2.docx            │ • file4.txt                          │
│                         │                                      │
│ Дубликаты:              │ Дубликаты:                           │
│ • report.pdf (MD5: A)   │ • report.pdf (MD5: B)               │
│                         │                                      │
│ Подозрительные:         │ Подозрительные:                      │
│ • doc1.pdf (MD5: X)     │ • doc2.pdf (MD5: X)                 │
└──────────────────────────┴──────────────────────────────────────┘
│                                                                 │
│ Статус: [████████░░] 80%                                      │
│ Текущий файл: file1.pdf                                        │
│ Обработано: 8 из 10 файлов                                     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### Функциональность:
- Выбор двух папок или дисков для синхронизации
- Выбор стратегии разрешения конфликтов
- Анализ различий между папками (без выполнения синхронизации)
- Визуализация результатов анализа в двухпанельном виде
- Выполнение синхронизации с отслеживанием прогресса
- Отображение ошибок в процессе синхронизации
- Переключение языка интерфейса
- Управление пользователями (для администраторов)
- Переход к отчетам (для администраторов)
- Выход из системы

---

### 2.3 Модальное окно управления пользователями (User Management Modal)

**URL:** Открывается из экрана синхронизации (кнопка "Управление пользователями")

#### Описание
Модальное окно для управления пользователями системы. Доступно только администраторам.

#### Элементы интерфейса:

##### Заголовок модального окна:
- **Заголовок**: "Управление пользователями"
- **Кнопка закрытия**: "×" в правом верхнем углу

##### Список пользователей:
- **Таблица пользователей** с колонками:
  - ID
  - Имя пользователя
  - Роль (readonly, full, admin)
  - Статус (Активен/Неактивен)
  - Действия (Редактировать, Удалить)

##### Форма добавления пользователя:
- **Поле "Имя пользователя"**: Текстовое поле
- **Поле "Пароль"**: Поле ввода пароля
- **Селектор "Роль"**: Выпадающий список (readonly, full, admin)
- **Кнопка "Добавить пользователя"**

##### Модальное окно редактирования:
- **Поле "Имя пользователя"**: Только для чтения
- **Поле "Новый пароль"**: Опциональное поле для изменения пароля
- **Селектор "Роль"**: Выпадающий список
- **Чекбокс "Активен"**: Включение/отключение пользователя
- **Кнопка "Сохранить"**
- **Кнопка "Отмена"**

#### Визуальное представление:
```
┌─────────────────────────────────────────────────────────────┐
│ Управление пользователями                            [×]    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ Список пользователей:                                       │
│ ┌────┬──────────────┬──────────┬─────────┬──────────────┐ │
│ │ ID │ Имя          │ Роль     │ Статус  │ Действия     │ │
│ ├────┼──────────────┼──────────┼─────────┼──────────────┤ │
│ │ 1  │ admin        │ admin    │ Активен │ [✏️] [🗑️]    │ │
│ │ 2  │ user1        │ full     │ Активен │ [✏️] [🗑️]    │ │
│ │ 3  │ viewer       │ readonly │ Активен │ [✏️] [🗑️]    │ │
│ └────┴──────────────┴──────────┴─────────┴──────────────┘ │
│                                                             │
│ Добавить нового пользователя:                              │
│ Имя пользователя: [_____________]                          │
│ Пароль:          [_____________]                          │
│ Роль:            [full ▼]                                 │
│                    [Добавить пользователя]                 │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### Функциональность:
- Просмотр списка всех пользователей
- Создание нового пользователя с указанием роли
- Редактирование существующего пользователя (изменение пароля, роли, статуса)
- Удаление пользователя (с подтверждением)
- Защита от самоудаления: администратор не может удалить или деактивировать себя
- Валидация полей при создании/редактировании

---

### 2.4 Экран отчетов (Reports Page)

**URL:** `/reports`

#### Описание
Экран с отчетами и аналитикой системы. Доступен только администраторам.

#### Элементы интерфейса:

##### Заголовок:
- **Заголовок**: "Отчеты"
- **Кнопка "Назад"**: Возврат на страницу синхронизации
- **Информация о пользователе**: "Вошли как: [имя пользователя]"
- **Кнопка "Выйти"**: Выход из системы

##### Вкладки отчетов:
- **Вкладка "Активность"**: Отчет по активности пользователей
- **Вкладка "Сэкономленное место"**: Отчет по освобожденному дисковому пространству
- **Вкладка "Операции"**: Отчет по типам операций
- **Вкладка "Поврежденные PDF"**: Отчет по поврежденным PDF-файлам

#### 2.4.1 Вкладка "Активность"

##### Элементы:
- **Фильтры**:
  - Тип активности: Выпадающий список (Все, delete_file, copy_file, sync, delete_duplicates)
  - Лимит записей: Числовое поле (по умолчанию 100)
- **Таблица активности** с колонками:
  - Дата и время
  - Пользователь
  - Тип активности
  - Описание
  - Путь к документу
  - Сэкономлено места (байты)
  - Количество операций
- **Кнопка "Обновить"**: Обновление данных

##### Визуальное представление:
```
┌─────────────────────────────────────────────────────────────┐
│ Отчеты                                    [Назад] [Выйти]   │
├─────────────────────────────────────────────────────────────┤
│ [Активность] [Сэкономленное место] [Операции] [Поврежденные PDF] │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ Фильтры:                                                    │
│ Тип активности: [Все ▼]  Лимит: [100]  [Обновить]         │
│                                                             │
│ ┌──────────────┬──────────┬────────────┬──────────────────┐│
│ │ Дата         │ Пользователь │ Тип    │ Описание        ││
│ ├──────────────┼──────────┼────────────┼──────────────────┤│
│ │ 2024-01-15   │ admin    │ delete_    │ Удален файл...  ││
│ │ 10:30:25     │          │ duplicates │                  ││
│ │ 2024-01-15   │ admin    │ sync       │ Синхронизация... ││
│ │ 09:15:10     │          │            │                  ││
│ └──────────────┴──────────┴────────────┴──────────────────┘│
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 2.4.2 Вкладка "Сэкономленное место"

##### Элементы:
- **Фильтры**:
  - Начальная дата: Поле выбора даты
  - Конечная дата: Поле выбора даты
- **Статистические карточки**:
  - Общий объем сэкономленного места (в байтах, МБ, ГБ)
  - Общее количество операций
- **Детальная разбивка**:
  - Таблица по типам активности с объемом сэкономленного места
- **Кнопка "Обновить"**: Обновление данных

##### Визуальное представление:
```
┌─────────────────────────────────────────────────────────────┐
│ Отчеты                                    [Назад] [Выйти]   │
├─────────────────────────────────────────────────────────────┤
│ [Активность] [Сэкономленное место] [Операции] [Поврежденные PDF] │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ Фильтры:                                                    │
│ Начальная дата: [2024-01-01]  Конечная дата: [2024-01-31]  │
│                    [Обновить]                               │
│                                                             │
│ ┌──────────────────────┐  ┌──────────────────────┐       │
│ │ Сэкономлено места    │  │ Всего операций        │       │
│ │ 2.5 ГБ              │  │ 1,234                  │       │
│ └──────────────────────┘  └──────────────────────┘       │
│                                                             │
│ Разбивка по типам:                                         │
│ • delete_duplicates: 1.8 ГБ                               │
│ • delete_file: 0.7 ГБ                                      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 2.4.3 Вкладка "Операции"

##### Элементы:
- **Фильтры**:
  - Начальная дата: Поле выбора даты
  - Конечная дата: Поле выбора даты
- **Статистика по типам операций**:
  - Таблица с типами операций и количеством каждой
  - График или диаграмма (опционально)
- **Кнопка "Обновить"**: Обновление данных

##### Визуальное представление:
```
┌─────────────────────────────────────────────────────────────┐
│ Отчеты                                    [Назад] [Выйти]   │
├─────────────────────────────────────────────────────────────┤
│ [Активность] [Сэкономленное место] [Операции] [Поврежденные PDF] │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ Фильтры:                                                    │
│ Начальная дата: [2024-01-01]  Конечная дата: [2024-01-31]  │
│                    [Обновить]                               │
│                                                             │
│ Статистика операций:                                        │
│ ┌──────────────────────┬──────────────┐                    │
│ │ Тип операции        │ Количество   │                    │
│ ├──────────────────────┼──────────────┤                    │
│ │ delete_duplicates   │ 456          │                    │
│ │ sync                │ 234          │                    │
│ │ copy_file           │ 123          │                    │
│ │ delete_file         │ 89           │                    │
│ └──────────────────────┴──────────────┘                    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 2.4.4 Вкладка "Поврежденные PDF"

##### Элементы:
- **Фильтры**:
  - Диск: Выпадающий список (Все, C, D, E, ...)
  - Лимит: Числовое поле (по умолчанию 1000, максимум 5000)
- **Таблица поврежденных PDF** с колонками:
  - ID
  - Имя файла
  - Путь к файлу
  - Размер (байты)
  - Причина (не существует на диске / размер 0)
  - Действия (Удалить из базы)
- **Статистика**:
  - Общее количество поврежденных PDF
  - Общий размер (байты)
  - Разбивка по дискам
- **Кнопка "Обновить"**: Обновление данных
- **Кнопка "Удалить все"**: Удаление всех записей из базы (с подтверждением)

##### Визуальное представление:
```
┌─────────────────────────────────────────────────────────────┐
│ Отчеты                                    [Назад] [Выйти]   │
├─────────────────────────────────────────────────────────────┤
│ [Активность] [Сэкономленное место] [Операции] [Поврежденные PDF] │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ Фильтры:                                                    │
│ Диск: [Все ▼]  Лимит: [1000]  [Обновить] [Удалить все]    │
│                                                             │
│ ┌──────────────────────┐  ┌──────────────────────┐       │
│ │ Всего поврежденных  │  │ Общий размер         │       │
│ │ 156                 │  │ 0 байт                │       │
│ └──────────────────────┘  └──────────────────────┘       │
│                                                             │
│ ┌────┬──────────────┬──────────────────┬─────────────────┐│
│ │ ID │ Имя файла    │ Путь             │ Причина         ││
│ ├────┼──────────────┼──────────────────┼─────────────────┤│
│ │ 1  │ doc.pdf      │ D:\docs\doc.pdf  │ Не существует   ││
│ │ 2  │ file.pdf     │ C:\files\file.pdf│ Размер 0        ││
│ └────┴──────────────┴──────────────────┴─────────────────┘│
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### Функциональность:
- Просмотр отчетов по активности пользователей
- Анализ сэкономленного дискового пространства
- Статистика по типам операций
- Обнаружение поврежденных PDF-файлов
- Фильтрация данных по датам, типам активности, дискам
- Обновление данных в реальном времени
- Удаление записей о поврежденных PDF из базы данных
- Все отчеты полностью переведены на выбранный язык
- Таймаут 60 секунд для всех запросов отчетов

---

### 2.5 API Документация (Swagger UI)

**URL:** `/docs`

#### Описание
Интерактивная документация API с возможностью тестирования эндпоинтов прямо из браузера.

#### Элементы интерфейса:
- **Список всех эндпоинтов API**: Организованы по категориям
- **Описание каждого эндпоинта**: Параметры, запросы, ответы
- **Кнопка "Try it out"**: Для каждого эндпоинта
- **Форма ввода параметров**: После нажатия "Try it out"
- **Кнопка "Execute"**: Выполнение запроса
- **Отображение ответа**: JSON-ответ от сервера
- **Авторизация**: Кнопка "Authorize" для ввода JWT токена

#### Функциональность:
- Просмотр всех доступных эндпоинтов API
- Тестирование эндпоинтов с различными параметрами
- Авторизация с JWT токеном
- Просмотр схем запросов и ответов
- Копирование примеров кода для различных языков программирования

---

## 3. Дополнительные функции

### 3.1 CLI Интерфейс

Приложение также предоставляет командную строку для выполнения операций:

- `scan [--drive D]` - Сканирование дисков
- `list-documents [--drive D]` - Список документов
- `search "query" [--no-content]` - Поиск документов
- `stats` - Статистика
- `duplicates` - Поиск дубликатов
- `sync --drive1 D --drive2 E [--no-dry-run]` - Синхронизация дисков
- `reports activities|space-saved|operations [options]` - Отчеты

### 3.2 Автоматические функции

- **Автоматический выход**: После 1 часа бездействия пользователь автоматически выходит из системы
- **Отслеживание активности**: Система отслеживает движения мыши, нажатия клавиш, прокрутку для определения активности
- **Инициализация базы данных**: Автоматическое создание таблиц при первом запуске
- **Создание пользователя по умолчанию**: Автоматическое создание администратора (admin/admin) при первом запуске

---

## 4. Безопасность

### 4.1 Аутентификация
- JWT токены с истечением срока действия (30 минут)
- Хеширование паролей с использованием bcrypt
- Безопасное хранение токенов в localStorage браузера

### 4.2 Авторизация
- Контроль доступа на основе ролей
- Защита эндпоинтов в зависимости от роли пользователя
- Защита от самоудаления администраторов

### 4.3 Валидация
- Валидация всех входных данных
- Проверка существования файлов перед операциями
- Проверка прав доступа перед выполнением операций

---

## 5. Производительность

### 5.1 Оптимизация базы данных
- Индексы на часто используемых полях
- FTS5 для быстрого полнотекстового поиска
- Оптимизированные запросы SQL

### 5.2 Оптимизация операций
- Асинхронная обработка длительных операций
- Отслеживание прогресса для операций синхронизации
- Таймауты для предотвращения зависаний (60 секунд для отчетов)

### 5.3 Кэширование
- Сохранение языка в localStorage браузера
- Сохранение JWT токена для повторного использования

---

## 6. Заключение

DocuSync представляет собой полнофункциональную систему управления документами с удобным веб-интерфейсом, мощными возможностями поиска и синхронизации, а также комплексной системой отчетности. Система поддерживает многоязычность, имеет гибкую систему ролей и обеспечивает безопасность данных пользователей.

Все экраны спроектированы с учетом удобства использования и предоставляют интуитивно понятный интерфейс для выполнения всех основных операций с документами.

